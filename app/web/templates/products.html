{% extends "base.html" %}
{% block content %}
<div class="row g-3">
  <div class="col-lg-7">
    <div class="bg-white p-3 rounded shadow-sm">
      <h4>Products</h4>

      {% if request.query_params.get('msg') %}
        <div class="alert alert-info">{{ request.query_params.get('msg') }}</div>
      {% endif %}

      <table class="table table-sm">
        <thead>
          <tr>
            <th>Brand</th><th>Model</th><th>Name</th><th>WH</th><th>WH10</th>
          </tr>
        </thead>
        <tbody>
          {% for p in products %}
          <tr>
            <td>{{ p.brand }}</td>
            <td>{{ p.model }}</td>
            <td>{{ p.name }}</td>
            <td>{{ "%.2f"|format(p.wh_price) }}</td>
            <td>{{ "%.2f"|format(p.wh10_price) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="col-lg-5">
    <div class="bg-white p-3 rounded shadow-sm">
      <h4>Add product + Receive</h4>

      <form method="post" action="/products/add" id="productForm">
        <div class="mb-2">
          <label class="form-label">Brand</label>
          <select class="form-select" name="brand" id="brandSelect" required>
            {% for b in brands %}
              <option value="{{ b }}">{{ b }}</option>
            {% endfor %}
          </select>
          <div class="form-text">
            If brand is missing, add it in <a href="/brands">Brands</a>.
          </div>
        </div>

        <!-- Model builder: prefix dropdown + suffix input, hidden full model -->
        <div class="mb-2">
          <label class="form-label">Model</label>
          <div class="input-group">
            <select class="form-select" id="modelPrefixSelect" style="max-width: 45%;">
              <option value="">(no prefix)</option>
            </select>
            <input class="form-control" id="modelSuffixInput" placeholder="1086A" required>
          </div>
          <input type="hidden" name="model" id="modelFullInput">
          <div class="form-text">Result example: tf-1086A</div>
        </div>

        <div class="mb-2">
          <label class="form-label">Name</label>
          <input class="form-control" name="name" required>
        </div>

        <div class="mb-2">
          <label class="form-label">Wholesale cost (WH)</label>
          <input class="form-control" name="wh_price" type="number" step="0.01" required>
        </div>

        <hr/>

        <div class="mb-2">
          <label class="form-label">Source</label>
          <select class="form-select" name="source" required>
            {% for s in sources %}
              <option value="{{ s }}">{{ source_labels[s] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-2">
          <label class="form-label">Warehouse (destination)</label>
          <select class="form-select" name="warehouse" required>
            {% for w in warehouses %}
              <option value="{{ w }}">{{ warehouse_labels[w] }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-2">
          <label class="form-label">Qty</label>
          <input class="form-control" name="qty" type="number" step="0.01" required>
        </div>

        <button class="btn btn-primary">Save</button>
      </form>
    </div>
  </div>
</div>

<script>
async function loadPrefixes(brand) {
  const prefixSelect = document.getElementById("modelPrefixSelect");
  prefixSelect.innerHTML = '<option value="">(no prefix)</option>';

  try {
    const res = await fetch(`/api/brand-prefixes?brand=${encodeURIComponent(brand)}`);
    const data = await res.json();
    (data.prefixes || []).forEach(p => {
      const opt = document.createElement("option");
      opt.value = p;         // stored without dash
      opt.textContent = p + "-";
      prefixSelect.appendChild(opt);
    });
  } catch (e) {
    // keep default
  }
}

function buildFullModel() {
  const prefix = (document.getElementById("modelPrefixSelect").value || "").trim();
  const suffix = (document.getElementById("modelSuffixInput").value || "").trim();

  // required suffix is enforced by input 'required'
  let full = suffix;
  if (prefix) full = prefix + "-" + suffix;

  document.getElementById("modelFullInput").value = full;
}

document.addEventListener("DOMContentLoaded", async () => {
  const brandSelect = document.getElementById("brandSelect");
  await loadPrefixes(brandSelect.value);
  buildFullModel();

  brandSelect.addEventListener("change", async (e) => {
    await loadPrefixes(e.target.value);
    buildFullModel();
  });

  document.getElementById("modelPrefixSelect").addEventListener("change", buildFullModel);
  document.getElementById("modelSuffixInput").addEventListener("input", buildFullModel);

  document.getElementById("productForm").addEventListener("submit", (e) => {
    buildFullModel();
  });
});
</script>
{% endblock %}